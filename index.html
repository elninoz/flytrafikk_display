const https = require('https');
const { URL } = require('url');

// Simplified auth for OpenSky (basic auth only)
function getOpenSkyAuth() {
const username = process.env.OPENSKY_USERNAME;
const password = process.env.OPENSKY_PASSWORD;

if (username && password) {
const auth = Buffer.from(`${username}:${password}`).toString('base64');
return `Basic ${auth}`;
}
return null;
}

// Make HTTP request
async function makeRequest(url, headers = {}) {
return new Promise((resolve, reject) => {
const urlObj = new URL(url);

const options = {
hostname: urlObj.hostname,
port: 443,
path: urlObj.pathname + urlObj.search,
method: 'GET',
headers: {
'Accept': 'application/json',
'User-Agent': 'flytrafikk-display/1.0',
...headers
},
timeout: 10000
};

const req = https.request(options, (res) => {
let data = '';
res.on('data', (chunk) => data += chunk);

res.on('end', () => {
if (data.trim().startsWith('<')) { reject(new Error('HTML error page received')); return; } try {
    resolve(JSON.parse(data)); } catch (error) { reject(new Error(`JSON parse error: ${error.message}`)); } }); });
    req.on('error', reject); req.on('timeout', ()=> {
    req.destroy();
    reject(new Error('Request timeout'));
    });

    req.end();
    });
    }

    // Get aircraft details from AeroDataBox using registration
    async function getAircraftByRegistration(registration) {
    const rapidApiKey = process.env.RAPIDAPI_KEY;
    if (!rapidApiKey) return null;

    const url = `https://aerodatabox.p.rapidapi.com/aircraft/reg/${registration}`;

    try {
    const headers = {
    'X-RapidAPI-Key': rapidApiKey,
    'X-RapidAPI-Host': 'aerodatabox.p.rapidapi.com'
    };

    const data = await makeRequest(url, headers);
    console.log(`✅ Aircraft info received for ${registration}`);
    return data;
    } catch (error) {
    console.log(`❌ AeroDataBox aircraft lookup failed: ${error.message}`);
    return null;
    }
    }

    // Get flights by registration (more reliable than ICAO24)
    async function getFlightsByRegistration(registration) {
    const rapidApiKey = process.env.RAPIDAPI_KEY;
    if (!rapidApiKey) return null;

    const url = `https://aerodatabox.p.rapidapi.com/flights/aircraft/reg/${registration}`;

    try {
    const headers = {
    'X-RapidAPI-Key': rapidApiKey,
    'X-RapidAPI-Host': 'aerodatabox.p.rapidapi.com'
    };

    const data = await makeRequest(url, headers);
    console.log(`✅ Flight data received for ${registration}`);
    return data;
    } catch (error) {
    console.log(`❌ AeroDataBox flights lookup failed: ${error.message}`);
    return null;
    }
    }

    // Convert ICAO24 to potential registration
    function icao24ToRegistration(icao24) {
    // Norwegian aircraft: LN-xxx
    if (icao24.startsWith('0d')) {
    // Norwegian ICAO24 range: 0d0000-0d7fff
    const hex = icao24.substring(2);
    const num = parseInt(hex, 16);
    if (num < 32768) { // 0x8000 // Simple mapping - not 100% accurate but gives starting point const
        letters=String.fromCharCode(65 + (num % 26), 65 + ((num>> 5) % 26));
        const digit = (num >> 10) % 10;
        return `LN-${letters}${digit}`;
        }
        }

        // Add more country mappings as needed
        // Swedish: SE-xxx (ICAO24: 4a0000-4a7fff)
        // Danish: OY-xxx (ICAO24: 458000-45ffff)

        return null;
        }

        // Handle states request (aircraft positions)
        async function handleStatesRequest(lamin, lamax, lomin, lomax, headers) {
        const auth = getOpenSkyAuth();
        const authHeaders = auth ? { 'Authorization': auth } : {};

        const url =
        `https://opensky-network.org/api/states/all?lamin=${lamin}&lamax=${lamax}&lomin=${lomin}&lomax=${lomax}`;

        try {
        const data = await makeRequest(url, authHeaders);

        // Enhance each aircraft with potential registration and route info
        if (data.states) {
        const enhancedStates = await Promise.all(
        data.states.map(async (state) => {
        const icao24 = state[0];
        const callsign = state[1]?.trim();

        // Try to get registration from ICAO24
        const registration = icao24ToRegistration(icao24);

        // Enhanced state with additional info
        const enhancedState = [...state];

        // If we have registration, try to get route info
        if (registration) {
        try {
        const flightData = await getFlightsByRegistration(registration);
        if (flightData && flightData.length > 0) {
        const latestFlight = flightData[0];

        // Add route info to state (custom fields)
        enhancedState[17] = registration; // Add registration
        enhancedState[18] = latestFlight.departure?.airport?.iata; // Departure
        enhancedState[19] = latestFlight.arrival?.airport?.iata; // Arrival
        enhancedState[20] = latestFlight.aircraft?.model; // Aircraft type
        }
        } catch (error) {
        console.log(`Failed to enhance ${registration}: ${error.message}`);
        }
        }

        return enhancedState;
        })
        );

        data.states = enhancedStates;
        }

        return {
        statusCode: 200,
        headers,
        body: JSON.stringify(data)
        };
        } catch (error) {
        return {
        statusCode: 500,
        headers,
        body: JSON.stringify({ error: error.message })
        };
        }
        }

        // Handle specific aircraft lookup
        async function handleAircraftLookup(registration, headers) {
        try {
        const [aircraftInfo, flightData] = await Promise.all([
        getAircraftByRegistration(registration),
        getFlightsByRegistration(registration)
        ]);

        const result = {
        aircraft: aircraftInfo,
        flights: flightData
        };

        return {
        statusCode: 200,
        headers,
        body: JSON.stringify(result)
        };
        } catch (error) {
        return {
        statusCode: 500,
        headers,
        body: JSON.stringify({ error: error.message })
        };
        }
        }

        exports.handler = async (event, context) => {
        context.callbackWaitsForEmptyEventLoop = false;

        const headers = {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Headers': 'Content-Type',
        'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
        'Content-Type': 'application/json'
        };

        if (event.httpMethod === 'OPTIONS') {
        return { statusCode: 200, headers, body: '' };
        }

        try {
        const params = event.queryStringParameters || {};
        const { lamin, lamax, lomin, lomax, registration } = params;

        if (lamin && lamax && lomin && lomax) {
        return await handleStatesRequest(lamin, lamax, lomin, lomax, headers);
        } else if (registration) {
        return await handleAircraftLookup(registration, headers);
        } else {
        return {
        statusCode: 400,
        headers,
        body: JSON.stringify({
        error: 'Missing parameters',
        usage: 'Use ?lamin=&lamax=&lomin=&lomax= for positions or ?registration=LN-ABC for aircraft details'
        })
        };
        }
        } catch (error) {
        return {
        statusCode: 500,
        headers,
        body: JSON.stringify({ error: error.message })
        };
        }
        };